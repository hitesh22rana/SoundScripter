# Base image
FROM ubuntu:22.04 AS build

# Upadte and install the required packages
RUN apt-get update && \
    apt-get install -y wget build-essential  \
    && rm -rf /var/lib/apt/lists/* /var/cache/apt/archives/*

# Download and extract the files
RUN mkdir /whisper && \
    wget -q https://github.com/ggerganov/whisper.cpp/tarball/master -O - | \
    tar -xz -C /whisper --strip-components 1

# Set the working to /whisper
WORKDIR /whisper

# Download the quantized small.en model
RUN bash ./models/download-ggml-model.sh small.en

# Build the main file
RUN make main

# Production image
FROM ubuntu:22.04 AS production

# Update and clean
RUN apt-get update && \
    apt-get install -y build-essential  \
    && rm -rf /var/lib/apt/lists/* /var/cache/apt/archives/*

# Set the working directory
WORKDIR /root

# make the models directory
RUN mkdir /root/models

# copy the required files from the build image
COPY --from=build "/whisper/models/ggml-small.en.bin" "/root/models/ggml-small.en.bin"
COPY --from=build /whisper/main /usr/local/bin/whisper

# Set the entrypoint
CMD ["bash", "-c"]